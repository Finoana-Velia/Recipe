package com.example.Finoana.Core;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

import com.example.Finoana.Dto.InvoiceResponseDto;
import com.example.Finoana.Service.InvoiceService;

import static com.example.Finoana.Core.FileManagement.getDocument;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeMessage;
import lombok.AllArgsConstructor;

@Service
@AllArgsConstructor
public class EmailSender {
	
	private JavaMailSender mailSender;
	private InvoiceService invoiceService;
	
	public void sendEmail(String toMail,String subject,String body) {
		SimpleMailMessage message = new SimpleMailMessage();
		message.setFrom("sbakery775@gmail.com");
		message.setTo(toMail);
		message.setText(body);
		message.setSubject(subject);
		
		mailSender.send(message);
		System.out.println("Mail sended successfully");
	}
	
	public void sendHtmlEmail(String fromMail,String toMail, String subject) throws MessagingException{
		MimeMessage message = mailSender.createMimeMessage();
		message.setFrom(new InternetAddress(fromMail));
		message.setRecipients(MimeMessage.RecipientType.TO, toMail);
		message.setSubject(subject);
		
		String htmlContent = "<h1>This is a test Spring boot mail</h1>" + 
				"<p>it contain <strong>HTML</strong> code.</p>";
		message.setContent(htmlContent,"text/html; charset=utf-8");
		mailSender.send(message);
	}
	
	public void sendMailWithAttachment(String toMail, Long id) throws MessagingException, IOException {
		InvoiceResponseDto invoice = this.invoiceService.findById(id);
		
		MimeMessage message = mailSender.createMimeMessage();
		MimeMessageHelper helper = new MimeMessageHelper(message,true,"UTF-8");
		helper.setTo(toMail);
		helper.setSubject("Your order details from RestFood and Bakery");
		
		String htmlTemplate = this.readFile("src/main/resources/template/MailBody.html");
		String htmlContent = htmlTemplate.replace("${name}", invoice.getAccount().getFirstName());
		
		helper.setText(htmlContent);
		
		File file = getDocument(invoice,"invoices");
		helper.addAttachment(file.getName(),file);
		
		mailSender.send(message);
	}
	
	private String readFile(String filePath) throws IOException {
		Path path = Paths.get(filePath);
		return Files.readString(path, StandardCharsets.UTF_8);
	}

}
